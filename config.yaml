# DRIVE视网膜血管分割配置文件
# 项目: retina_ph_seg
# 阶段: Stage 0 - 数据验证框架

data:
  # ==================== 数据集选择 ====================
  # 双模式切换：false = 纯DRIVE, true = Kaggle联合数据集
  # 联合数据集: DRIVE-HRF-CHASE DB1-STARE (自动下载)
  use_kaggle_combined: true
  
  # 数据集根目录 (DRIVE模式使用)
  root: ./DRIVE

  # 训练集图像ID (16张: 21-36, DRIVE模式使用)
  train_ids: [21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36]

  # 验证集图像ID (4张: 37-40)
  val_ids: [37, 38, 39, 40]

  # 测试集图像ID (20张: 01-20, 仅用于最终推理)
  test_ids: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]

  # 图像预处理参数
  img_size: 512          # 输入图像尺寸 (原图565×584，512接近原尺寸且是2的幂次)
                         # 调大：增加细节，但内存消耗增加，可能需减小batch_size。
                         # 调小：减少计算量，但可能丢失细微血管，影响分割精度。

  # in_channels: 3      # 已统一为RGB 3通道（见data_drive.py和train_with_topology.py）
                         # 所有数据集（DRIVE和Kaggle）统一输出RGB [3,H,W]

  # 数据增强参数 (Stage 0仅使用最基础的增强)
  augmentation:
    horizontal_flip: true    # 水平翻转。开启增加数据多样性，减少过拟合，对血管对称性无影响。
    rotation_range: 0        # 暂不启用旋转。若开启可提升旋转不变性，但需注意血管方向性可能受影响。
    brightness_range: 0.0    # 暂不启用亮度调整。若开启可增强亮度鲁棒性，但可能改变对比度影响分割。

# 训练参数 (Stage 1使用)
training:
  batch_size: 4          # 批次大小。调大：梯度估计更准，收敛更稳定，但显存需求大；调小：可能震荡，需降低学习率。
  num_workers: 4         # 数据加载线程数。调大：加快数据加载，但过多可能增加CPU开销；调小：可能成为瓶颈。
  learning_rate: 1.0e-4  # 初始学习率。调大：收敛快，但可能不稳定或错过最优；调小：收敛慢，但更稳定。
  max_epochs: 200        # 最大训练轮数。调大：有机会更好，但可能过拟合；调小：可能欠拟合。
  patience: 20           # 早停耐心值（监控val_dice）。调大：允许更多轮无改善，可能避免早停，但延长训练。
                         # 调小：更早停止，防止过拟合，但可能错过后续提升。
  device: cuda
  seed: 42               # 随机种子。固定后可复现结果。

  # 检查点设置
  checkpoint_dir: ./checkpoints
  save_best_only: true   # 仅保存最佳模型。若false会保存所有，占用磁盘。

  # 日志设置
  log_dir: ./logs
  log_csv: true          # 保存CSV日志。

# 模型参数 (Stage 1使用)
model:
  name: unet
  encoder: resnet34      # 编码器（统一使用RGB 3通道输入，适配ImageNet预训练权重）
  pretrained: true       # ImageNet预训练权重。true加快收敛，提升性能，但需适配单通道。
  encoder_weights: imagenet
  activation: null       # 输出logits，不激活（smp.losses.DiceLoss会自动sigmoid）

# 损失函数参数
loss:
  name: dice
  mode: binary

# 评估指标参数
metrics:
  compute_topology: true    # 是否计算CL-Break和Δβ₀（仅日志，不影响训练）。开启可监控拓扑性能。
  topology_threshold: 0.5   # 二值化阈值（计算拓扑指标用）。调高：分割更保守，可能减少假阳性，但增加断裂；
                            # 调低：分割更敏感，可能增加假阳性，但连通性更好。

# 拓扑损失参数（经典稳定版）
topology:
  target_beta0: 5          # 目标连通分量数（经典版固定5，适合血管树）
  max_death: 0.5           # filtration域中最大death值

  # 课程学习策略（Curriculum Learning）：先训练CNN，再引入拓扑约束
  # 策略说明：
  # - 阶段1: 先纯Dice训练50轮，建立基础像素精度（CNN预热）
  # - 阶段2: λ=0.05训练50轮，轻度拓扑微调（引入拓扑概念）
  # - 阶段3: λ=0.15训练100轮，适度拓扑优化（稳定收敛）
  #
  # 总损失 = L_Dice + λ * L_topo
  # 
  # 设计理由：
  # 1. 避免早期拓扑约束过强导致CNN无法学习基础特征
  # 2. 分阶段渐进式引入，防止过连通（over-connecting）
  # 3. λ_max=0.15 < 0.2，确保拓扑不主导总损失
  phase1_epochs: 50         # 阶段1：纯Dice（CNN预热）。调长：网络更稳定后再引入拓扑，但总训练时间增加；
                            # 调短：过早引入拓扑可能干扰基础特征学习。
  phase2_epochs: 50         # 阶段2：弱拓扑（λ=0.05）。调长：更温和的过渡；调短：快速进入强拓扑，可能不稳定。
  phase3_epochs: 100        # 阶段3：适度拓扑（λ=0.15）。调长：更多优化机会，但可能过拟合；调短：拓扑学习不足。
  lambda_phase2: 0.10       # 阶段2的λ值（中度拓扑）。调大：拓扑约束更强，可能修复断裂，但过度连接风险增加；
                            # 调小：拓扑影响弱，可能断裂改善有限。
  lambda_phase3: 0.25       # 阶段3的λ值（较强拓扑，最大0.25）。同上，但此阶段拓扑更重要，需平衡。
  compute_freq: 1           # 拓扑损失计算频率（每N个iteration）。调大：每N次算一次，节省计算，但梯度更新滞后；
                            # 调小：更频繁，但计算负担重。设为1则每次迭代都算。
  disable_skip: true       # 是否禁用跳步计算（调试用）。若false且compute_freq>1，则跳步，可能影响收敛一致性。

  # 边缘保护参数（防止假阳性桥接）
  edge_protect: true        # 启用硬边界保护。开启后，高置信度前景/背景区域被强制不改变，防止错误连接。
  high_confidence_thresh: 0.9  # 高置信度前景阈值（不允许降低）。调高：更保守，允许调整的区域更少；调低：允许更多调整。
  low_confidence_thresh: 0.1   # 高置信度背景阈值（不允许提高）。调高：背景更易被保护；调低：背景更易被激活。


  # 消融实验开关（验证拓扑损失有效性）
  # 设为true可禁用拓扑损失，仅训练Dice基线
  disable_topo_loss: false  # 默认false（启用拓扑损失）。用于对比实验，评估拓扑损失带来的增益。